<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Site Title-->
    <title>Explore</title>
    <meta name="format-detection" content="telephone=no">
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=1">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta charset="utf-8">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <link rel="icon" href="{{ url_for('static', filename='images/logo-soccer-default-95x126.png') }}">
    <!-- Stylesheets-->
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Kanit:300,400,500,500i,600,900%7CRoboto:400,900">
    <link rel="stylesheet" href="{{ url_for('static', filename='css6_explore/style.css') }}">
    
</head>

<body>
    <h4 class="text-muted">Explore</h4>
    <hr>
    
    <div class="row row-cols-3 mb-4" id="posts-container">
    </div>

    <script type="text/javascript">
        const SCRIPT_ROOT = "{{ url_for('index', _external=True).rstrip('/') }}";

        let page_count = 1;
        let end_reached = false;
        
        // Function to escape HTML to prevent XSS
        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, function(m) { return map[m]; });
        }

        function getCSRFToken() {
            const token = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            return token;
        }

        document.addEventListener('DOMContentLoaded', () => {
            load_posts(page_count++);
    
            window.onscroll = () => {
                // check if we reached the bottom
                if(window.innerHeight + window.scrollY >= document.body.offsetHeight && end_reached == false) {
                    // alert("bottom");
                    load_posts(page_count++);
                }
            }; 
        });

        const csrfToken = getCSRFToken();
        async function load_posts(start) {
            try {
                const response = await fetch(`${SCRIPT_ROOT}/explore`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify({ start: start })
                });

                if (!response.ok) {
                    const errorText = await response.text();  // Read response body as text
                    throw new Error(`HTTP error! Status: ${response.status}, ${errorText}`);
                }

                const data = await response.json();
                console.log(data);
    
                if (data.success) {
                    if (data.result.length === 0) {
                        end_reached = true;
                        return;
                    }
                    
                    // Append the posts
                    data.result.forEach(post => {
                        // create a new div for each post
                        const postDiv = document.createElement('div');
                        postDiv.className = 'post';
                    
                        const postContent = `
                            <h2>${escapeHtml(post.username)}</h2>
                            <div class="col p-2 img-wrapper rounded">
                                <a href="${post.post_url}"><img class="post-img" src="${escapeHtml(post.media)}"></a>
                            </div>
                            <p>${escapeHtml(post.content)}</p>
                            <small>Posted on: ${escapeHtml(post.date_posted)}</small>
                            <p>Likes: ${escapeHtml(post.like_count.toString())}</p>
                            <p>Comments: ${escapeHtml(post.comment_count.toString())}</p>
                        `;
                        postDiv.innerHTML = postContent;

                        // Append the new post to the container
                        document.getElementById('posts-container').appendChild(postDiv);

                    });
                } else {
                    alert("Something went wrong", data.result);
                }
            } catch (error) {
                console.error("Error loading posts:", error);
            }
        }
    </script>
</body>
</html>
